version: '3'

vars:
  BUILD_TARGET: '//lib:libsorbet'
  DOCKER_IMAGE: 'sorbet-builder'

tasks:
  docker:build:
    desc: Build Docker image for Linux builds
    cmds:
      - docker build -t {{.DOCKER_IMAGE}} .
    sources:
      - Dockerfile

  build:macos:
    desc: Build libsorbet for macOS (.dylib) - Fixed for macOS Sequoia 15+
    cmds:
      - bazel build {{.BUILD_TARGET}}.dylib
      - mkdir -p ../dist/macos
      - |
        # Find the actual built library (bazel-bin symlink may not exist)
        DYLIB=$(find /private/var/tmp/_bazel_* -path "*/darwin_arm64-fastbuild/bin/lib/libsorbet.dylib" 2>/dev/null | head -1)
        if [ -n "$DYLIB" ]; then
          cp -f "$DYLIB" ../dist/macos/
          echo "‚úÖ Built: ../dist/macos/libsorbet.dylib"
        else
          echo "‚ùå Error: Could not find libsorbet.dylib"
          exit 1
        fi
    sources:
      - sorbet_c_api.cc
      - BUILD
    generates:
      - ../dist/macos/libsorbet.dylib

  build:macos:docker:
    desc: Build libsorbet using Docker (workaround for macOS Sequoia)
    deps: [docker:build]
    cmds:
      - echo "macOS builds via Docker not fully supported - use native Linux Docker build instead"

  build:linux:
    desc: Build libsorbet for Linux (.so)
    cmds:
      - mkdir -p ../dist/linux
      - bazel build {{.BUILD_TARGET}}.so && cp -f ../bazel-bin/lib/libsorbet.so ../dist/linux/
    sources:
      - sorbet_c_api.cc
      - BUILD
      - Dockerfile
    generates:
      - ../dist/linux/libsorbet.so

  build:macos:static:
    desc: Build TRUE static library libsorbet.a (not hybrid)
    cmds:
      - echo "üî® Building Sorbet with static linking configuration..."
      - bazel build //lib:libsorbet_static
      - mkdir -p ../dist/macos
      - |
        # Find the actual built library (bazel-bin symlink may not exist)
        STATIC_LIB=$(find /private/var/tmp/_bazel_* -path "*/darwin_arm64-fastbuild/bin/lib/libsorbet.a" 2>/dev/null | head -1)
        if [ -n "$STATIC_LIB" ]; then
          cp -f "$STATIC_LIB" ../dist/macos/
          echo "‚úÖ Built: ../dist/macos/libsorbet.a"
        else
          echo "‚ùå Error: Could not find libsorbet.a"
          exit 1
        fi
    sources:
      - sorbet_c_api.cc
      - BUILD
    generates:
      - ../dist/macos/libsorbet.a

  build:linux:static:
    desc: Build TRUE static library libsorbet.a for Linux
    cmds:
      - echo "üî® Building Sorbet (Linux) with static linking configuration..."
      - bazel build //lib:libsorbet_static
      - mkdir -p ../dist/linux
      - |
        # Use bazel info to find the output directory reliably
        BAZEL_BIN=$(bazel info bazel-bin)
        STATIC_LIB="$BAZEL_BIN/lib/libsorbet.a"
        if [ -f "$STATIC_LIB" ]; then
          cp -f "$STATIC_LIB" ../dist/linux/
          echo "‚úÖ Built: ../dist/linux/libsorbet.a"
        else
          echo "‚ùå Error: Could not find libsorbet.a at $STATIC_LIB"
          # Fallback search if bazel info fails or path differs
          FOUND=$(find ../bazel-out -name libsorbet.a | grep "bin/lib/libsorbet.a" | head -1)
          if [ -n "$FOUND" ]; then
             cp -f "$FOUND" ../dist/linux/
             echo "‚úÖ Built (via fallback): ../dist/linux/libsorbet.a"
          else
             exit 1
          fi
        fi

        echo "‚úÖ Built: ../dist/linux/libsorbet.a"
        ls -lh ../dist/linux/libsorbet.a
    sources:
      - sorbet_c_api.cc
      - BUILD
    generates:
      - ../dist/linux/libsorbet.a

  build:windows:
    desc: Build libsorbet for Windows (.dll)
    cmds:
      - mkdir -p ../dist/windows
      - bazel build //lib:libsorbet.dll
      - cp -f bazel-bin/lib/libsorbet.dll ../dist/windows/
    sources:
      - sorbet_c_api.cc
      - BUILD
    generates:
      - ../dist/windows/libsorbet.dll

  build:windows:static:
    desc: Build TRUE static library libsorbet.lib for Windows
    cmds:
      - mkdir -p ../dist/windows
      - bazel build --enable_workspace --action_env=PATH //lib:libsorbet_static_windows
      - cp -f ../bazel-bin/lib/libsorbet.lib ../dist/windows/libsorbet.lib
      - echo "Built ../dist/windows/libsorbet.lib"
    sources:
      - sorbet_c_api.cc
      - BUILD
    generates:
      - ../dist/windows/libsorbet.lib

  build:all:
    desc: Build libsorbet for all supported platforms
    cmds:
      - task: build:macos
      - task: build:linux
      - task: build:windows

  clean:
    desc: Clean build artifacts
    cmds:
      - bazel clean
      - rm -rf ../dist/macos ../dist/linux ../dist/windows

  install:macos:
    desc: Install libsorbet to system (macOS)
    deps: [build:macos]
    cmds:
      - sudo cp ../dist/macos/libsorbet.dylib /usr/local/lib/
      - sudo install_name_tool -id /usr/local/lib/libsorbet.dylib /usr/local/lib/libsorbet.dylib

  install:linux:
    desc: Install libsorbet to system (Linux)
    deps: [build:linux]
    cmds:
      - sudo cp ../dist/linux/libsorbet.so /usr/local/lib/
      - sudo ldconfig

  test:
    desc: Test the library with the Crystal example
    deps: [build:macos]
    cmds:
      - cd ../crystal && crystal build main.cr -L../dist/macos
      - cd ../crystal && ./main
